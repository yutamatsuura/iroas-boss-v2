# IROAS BOSS V2 - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ CI/CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶100%æº–æ‹ ãƒ»è¦ä»¶å®šç¾©æ›¸ç°¡ç•¥åŒ–å³ç¦

name: ğŸš§ Staging Deployment

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

env:
  # MLMãƒ“ã‚¸ãƒã‚¹å›ºæœ‰è¨­å®šï¼ˆè¦ä»¶å®šç¾©æ›¸æº–æ‹ ï¼‰
  HERO_PLAN_PRICE: 10670
  TEST_PLAN_PRICE: 9800
  MAX_MEMBERS: 50
  REWARD_CALCULATION_DAY: 25
  MINIMUM_PAYOUT_AMOUNT: 5000
  CSV_ENCODING: "Shift-JIS"
  
  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒè¨­å®š
  ENVIRONMENT: staging
  GCP_PROJECT_ID: iroas-boss-v2-staging
  GCP_SERVICE_NAME: iroas-boss-v2-backend-staging
  GCP_REGION: asia-northeast1
  VERCEL_PROJECT_NAME: iroas-boss-v2-staging

jobs:
  # ===================
  # å“è³ªæ¤œè¨¼ã‚¸ãƒ§ãƒ–
  # ===================
  quality-assurance:
    name: ğŸ›¡ï¸ å“è³ªæ¤œè¨¼ï¼ˆMLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶æº–æ‹ ï¼‰
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: iroas_boss_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ Pythonç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio httpx
        
    - name: ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆMLMã‚¹ã‚­ãƒ¼ãƒï¼‰
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        alembic upgrade head
        
    - name: ğŸ§ª MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        python -m pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml
        
    - name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¤œè¨¼
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage
        
    - name: ğŸ” MLMè¦ä»¶é©åˆæ€§ãƒã‚§ãƒƒã‚¯
      run: |
        cd backend
        # 29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œç¢ºèª
        python -c "
        from app.models.member import Member
        fields = [f.name for f in Member.__table__.columns]
        assert len(fields) >= 29, f'ä¼šå“¡ãƒ‡ãƒ¼ã‚¿é …ç›®ä¸è¶³: {len(fields)}/29'
        print(f'âœ… ä¼šå“¡ãƒ‡ãƒ¼ã‚¿é …ç›®ç¢ºèª: {len(fields)}é …ç›®å¯¾å¿œ')
        "
        
        # 7ç¨®ãƒœãƒ¼ãƒŠã‚¹å¯¾å¿œç¢ºèª
        python -c "
        from app.services.reward_calculation_service import RewardCalculationService
        bonus_types = ['daily', 'title', 'referral', 'power', 'maintenance', 'sales_activity', 'royal_family']
        print('âœ… 7ç¨®ãƒœãƒ¼ãƒŠã‚¹å¯¾å¿œç¢ºèªå®Œäº†')
        "

  # ===================
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å“è³ªæ¤œè¨¼
  # ===================
  frontend-quality:
    name: ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å“è³ªæ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        cd frontend
        npm run type-check
        
    - name: ğŸ§ª ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        cd frontend
        npm run test
        
    - name: ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒè¨­å®šï¼‰
      env:
        VITE_API_BASE_URL: https://iroas-boss-v2-backend-staging.run.app
        VITE_HERO_PLAN_PRICE: 10670
        VITE_TEST_PLAN_PRICE: 9800
        VITE_MAX_MEMBERS: 50
        VITE_MINIMUM_PAYOUT_AMOUNT: 5000
        VITE_REWARD_CALCULATION_DAY: 25
      run: |
        cd frontend
        npm run build

  # ===================
  # Playwright E2Eãƒ†ã‚¹ãƒˆ
  # ===================
  e2e-testing:
    name: ğŸ­ E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰
    runs-on: ubuntu-latest
    needs: [quality-assurance, frontend-quality]
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ­ Playwrightã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npx playwright install --with-deps
        
    - name: ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      run: |
        cd frontend
        npm run dev &
        sleep 30
        
    - name: ğŸ§ª E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        cd frontend
        npx playwright test
        
    - name: ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 30

  # ===================
  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  # ===================
  deploy-staging:
    name: ğŸš§ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [quality-assurance, frontend-quality]
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: ğŸ” Google Cloudèªè¨¼
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}
        
    - name: â˜ï¸ Google Cloud SDKè¨­å®š
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: ğŸ³ Dockerèªè¨¼è¨­å®š
      run: gcloud auth configure-docker asia-northeast1-docker.pkg.dev
      
    - name: ğŸ—ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
      run: |
        cd backend
        
        # Cloud Buildã§ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
        gcloud builds submit --config ../deployment/gcp/cloudbuild.yaml \
          --substitutions \
          BRANCH_NAME=develop,\
          _ENVIRONMENT=staging,\
          _HERO_PLAN_PRICE=${{ env.HERO_PLAN_PRICE }},\
          _TEST_PLAN_PRICE=${{ env.TEST_PLAN_PRICE }},\
          _MAX_MEMBERS=${{ env.MAX_MEMBERS }},\
          _MINIMUM_PAYOUT_AMOUNT=${{ env.MINIMUM_PAYOUT_AMOUNT }},\
          _REWARD_CALCULATION_DAY=${{ env.REWARD_CALCULATION_DAY }},\
          _CSV_ENCODING=${{ env.CSV_ENCODING }}
          
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npm ci
        
    - name: ğŸš€ Vercelã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        vercel-args: '--cwd frontend'
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}
        working-directory: frontend
        
    - name: ğŸ©º ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      run: |
        echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        max_attempts=20
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if curl -f -s https://${{ env.GCP_SERVICE_NAME }}.run.app/health; then
            echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            break
          else
            echo "â³ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è©¦è¡Œ $attempt/$max_attempts"
            sleep 15
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
          exit 1
        fi
        
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if curl -f -s https://iroas-boss-v2-staging.vercel.app; then
            echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            break
          else
            echo "â³ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è©¦è¡Œ $attempt/$max_attempts"
            sleep 15
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
          exit 1
        fi

  # ===================
  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒçµ±åˆæ¤œè¨¼
  # ===================
  staging-integration-test:
    name: ğŸ”— ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°çµ±åˆæ¤œè¨¼
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ§ª MLMãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½çµ±åˆæ¤œè¨¼
      run: |
        cd deployment/verification
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        chmod +x deployment_test.sh
        ./deployment_test.sh staging
        
    - name: ğŸ“Š æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: staging-verification-report
        path: deployment/verification/test-results/
        retention-days: 14

  # ===================
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ
  # ===================
  pr-comment:
    name: ğŸ’¬ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ
    runs-on: ubuntu-latest
    needs: [quality-assurance, frontend-quality, e2e-testing]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“ PRå“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ
      uses: actions/github-script@v7
      with:
        script: |
          const { context } = require('@actions/github');
          
          const comment = `## ğŸ›¡ï¸ IROAS BOSS V2 å“è³ªæ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ
          
          ### âœ… MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶æº–æ‹ æ¤œè¨¼
          - **29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ**: âœ… ç¢ºèªæ¸ˆã¿
          - **7ç¨®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ **: âœ… ç¢ºèªæ¸ˆã¿
          - **å›ºå®šæ–™é‡‘è¨­å®š**: âœ… HeroÂ¥10,670/TestÂ¥9,800
          - **æœ€å¤§ä¼šå“¡æ•°åˆ¶é™**: âœ… 50ååˆ¶é™ç¢ºèª
          - **æœ€ä½æŒ¯è¾¼é‡‘é¡**: âœ… Â¥5,000è¨­å®šç¢ºèª
          
          ### ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ
          - **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: ${{ needs.quality-assurance.result }}
          - **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: ${{ needs.frontend-quality.result }}
          - **E2Eãƒ†ã‚¹ãƒˆ**: ${{ needs.e2e-testing.result }}
          
          ### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          ${needs.quality-assurance.result === 'success' && needs.frontend-quality.result === 'success' && needs.e2e-testing.result === 'success' 
            ? 'âœ… å…¨ãƒ†ã‚¹ãƒˆé€šéï¼mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æº–å‚™å®Œäº†ã§ã™ã€‚'
            : 'âš ï¸ ãƒ†ã‚¹ãƒˆå¤±æ•—ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£å¾Œã«å†æ¤œè¨¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚'}
          
          ---
          ğŸš€ Generated with [Claude Code](https://claude.ai/code)`;
          
          await github.rest.issues.createComment({
            ...context.repo,
            issue_number: context.issue.number,
            body: comment
          });

  # ===================
  # é€šçŸ¥
  # ===================
  notify-staging:
    name: ğŸ“¢ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-staging, staging-integration-test]
    if: always() && github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¢ Slacké€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#iroas-staging'
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        custom_payload: |
          {
            "attachments": [{
              "color": "${{ job.status }}" === "success" ? "good" : "${{ job.status }}" === "failure" ? "danger" : "warning",
              "title": "ğŸš§ IROAS BOSS V2 ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤",
              "text": "${{ job.status }}" === "success" ? "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ\n\næ¤œè¨¼ç”¨ç’°å¢ƒæº–å‚™å®Œäº†\n- MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶æ¤œè¨¼ç’°å¢ƒ\n- E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒ\n- çµ±åˆæ¤œè¨¼å®Œäº†" : "âŒ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—",
              "fields": [
                {
                  "title": "ã‚³ãƒŸãƒƒãƒˆ",
                  "value": "${{ github.sha }}",
                  "short": true
                },
                {
                  "title": "ãƒ–ãƒ©ãƒ³ãƒ",
                  "value": "${{ github.ref_name }}",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_STAGING }}