# IROAS BOSS V2 - ãƒªãƒªãƒ¼ã‚¹ç®¡ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶100%æº–æ‹ ãƒ»ãƒªãƒªãƒ¼ã‚¹å“è³ªä¿è¨¼

name: ğŸš¢ Release Management

on:
  release:
    types: [created, published]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
        - hotfix
      environment:
        description: 'ãƒªãƒªãƒ¼ã‚¹å¯¾è±¡ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - all

env:
  # MLMãƒ“ã‚¸ãƒã‚¹å›ºæœ‰è¨­å®šï¼ˆè¦ä»¶å®šç¾©æ›¸æº–æ‹ ï¼‰
  HERO_PLAN_PRICE: 10670
  TEST_PLAN_PRICE: 9800
  MAX_MEMBERS: 50
  REWARD_CALCULATION_DAY: 25
  MINIMUM_PAYOUT_AMOUNT: 5000
  CSV_ENCODING: "Shift-JIS"

jobs:
  # ===================
  # ãƒªãƒªãƒ¼ã‚¹å‰å“è³ªæ¤œè¨¼
  # ===================
  pre-release-validation:
    name: ğŸ›¡ï¸ ãƒªãƒªãƒ¼ã‚¹å‰å“è³ªæ¤œè¨¼
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: iroas_boss_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ Pythonç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio httpx
        
    - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        alembic upgrade head
        
    - name: ğŸ§ª ãƒªãƒªãƒ¼ã‚¹å‰ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
        cd backend
        python -m pytest tests/ -v --cov=app --cov-fail-under=80
        
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
        cd ../frontend
        npm run test
        npm run type-check
        
    - name: ğŸ” MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶æœ€çµ‚ç¢ºèª
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        python -c "
        from app.models.member import Member
        from app.services.reward_calculation_service import RewardCalculationService
        import os
        
        # 29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        fields = [f.name for f in Member.__table__.columns]
        assert len(fields) >= 29, f'ä¼šå“¡ãƒ‡ãƒ¼ã‚¿é …ç›®ä¸è¶³: {len(fields)}/29'
        
        # å›ºå®šæ–™é‡‘ç¢ºèª
        hero_price = int(os.environ.get('HERO_PLAN_PRICE', 0))
        test_price = int(os.environ.get('TEST_PLAN_PRICE', 0))
        assert hero_price == 10670 and test_price == 9800, 'æ–™é‡‘è¨­å®šç•°å¸¸'
        
        print('âœ… ãƒªãƒªãƒ¼ã‚¹å‰MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶ç¢ºèªå®Œäº†')
        "

  # ===================
  # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
  # ===================
  version-management:
    name: ğŸ“ˆ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
    runs-on: ubuntu-latest
    needs: [pre-release-validation]
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“ˆ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—
      id: version
      run: |
        # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
        current_version=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Current version: $current_version"
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·æŠ½å‡º
        version_number=${current_version#v}
        IFS='.' read -ra VERSION_PARTS <<< "$version_number"
        major=${VERSION_PARTS[0]}
        minor=${VERSION_PARTS[1]}
        patch=${VERSION_PARTS[2]}
        
        # æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—
        case "${{ github.event.inputs.release_type }}" in
          major)
            major=$((major + 1))
            minor=0
            patch=0
            ;;
          minor)
            minor=$((minor + 1))
            patch=0
            ;;
          patch|hotfix)
            patch=$((patch + 1))
            ;;
        esac
        
        new_version="v${major}.${minor}.${patch}"
        echo "New version: $new_version"
        echo "new_version=$new_version" >> $GITHUB_OUTPUT
        
    - name: ğŸ“ å¤‰æ›´å±¥æ­´ç”Ÿæˆ
      id: changelog
      run: |
        echo "## ğŸš€ IROAS BOSS V2 ${{ steps.version.outputs.new_version }}" > changelog.md
        echo "" >> changelog.md
        echo "### ğŸ¢ MLMãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½" >> changelog.md
        echo "- âœ… 29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿å®Œå…¨å¯¾å¿œ" >> changelog.md
        echo "- âœ… 7ç¨®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ " >> changelog.md
        echo "- âœ… å›ºå®šæ–™é‡‘è¨­å®šï¼ˆHeroÂ¥10,670/TestÂ¥9,800ï¼‰" >> changelog.md
        echo "- âœ… æœ€å¤§ä¼šå“¡æ•°50ååˆ¶é™" >> changelog.md
        echo "- âœ… Univapayãƒ»GMOé€£æºæº–å‚™" >> changelog.md
        echo "" >> changelog.md
        echo "### ğŸ“Š å¤‰æ›´å†…å®¹" >> changelog.md
        git log --oneline $(git describe --tags --abbrev=0)..HEAD >> changelog.md
        
        changelog_content=$(cat changelog.md)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$changelog_content" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

  # ===================
  # æœ¬ç•ªç’°å¢ƒãƒªãƒªãƒ¼ã‚¹
  # ===================
  production-release:
    name: ğŸš€ æœ¬ç•ªç’°å¢ƒãƒªãƒªãƒ¼ã‚¹
    runs-on: ubuntu-latest
    needs: [pre-release-validation, version-management]
    if: github.event.inputs.environment == 'production' || github.event.inputs.environment == 'all'
    environment: production
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ä½œæˆ
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ needs.version-management.outputs.new_version }}
        git push origin ${{ needs.version-management.outputs.new_version }}
        
    - name: ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'ci-cd-production.yml',
            ref: 'main',
            inputs: {
              deployment_target: 'all'
            }
          });
        
    - name: ğŸ“‹ GitHub Releaseä½œæˆ
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.version-management.outputs.new_version }}
        release_name: 'IROAS BOSS V2 ${{ needs.version-management.outputs.new_version }}'
        body: ${{ needs.version-management.outputs.changelog }}
        draft: false
        prerelease: false

  # ===================
  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒªãƒªãƒ¼ã‚¹
  # ===================
  staging-release:
    name: ğŸš§ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒªãƒªãƒ¼ã‚¹
    runs-on: ubuntu-latest
    needs: [pre-release-validation, version-management]
    if: github.event.inputs.environment == 'staging' || github.event.inputs.environment == 'all'
    environment: staging
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸš§ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'ci-cd-staging.yml',
            ref: 'develop'
          });

  # ===================
  # ãƒªãƒªãƒ¼ã‚¹å¾Œæ¤œè¨¼
  # ===================
  post-release-validation:
    name: ğŸ” ãƒªãƒªãƒ¼ã‚¹å¾Œæ¤œè¨¼
    runs-on: ubuntu-latest
    needs: [production-release, staging-release]
    if: always() && (needs.production-release.result == 'success' || needs.staging-release.result == 'success')
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œçµ±åˆæ¤œè¨¼
      run: |
        cd deployment/verification
        
        if [[ "${{ github.event.inputs.environment }}" == "production" || "${{ github.event.inputs.environment }}" == "all" ]]; then
          echo "æœ¬ç•ªç’°å¢ƒæ¤œè¨¼å®Ÿè¡Œ"
          chmod +x deployment_test.sh
          ./deployment_test.sh production
        fi
        
        if [[ "${{ github.event.inputs.environment }}" == "staging" || "${{ github.event.inputs.environment }}" == "all" ]]; then
          echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒæ¤œè¨¼å®Ÿè¡Œ"
          chmod +x deployment_test.sh
          ./deployment_test.sh staging
        fi
        
    - name: ğŸ“Š æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: release-validation-report
        path: deployment/verification/test-results/
        retention-days: 90

  # ===================
  # ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥
  # ===================
  release-notification:
    name: ğŸ“¢ ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [production-release, staging-release, post-release-validation]
    if: always()
    
    steps:
    - name: ğŸ“¢ Slacké€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: custom
        channel: '#iroas-releases'
        custom_payload: |
          {
            "attachments": [{
              "color": "${{ needs.production-release.result == 'success' || needs.staging-release.result == 'success' }}" === "true" ? "good" : "danger",
              "title": "ğŸš¢ IROAS BOSS V2 ãƒªãƒªãƒ¼ã‚¹å®Œäº†",
              "text": "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ needs.version-management.outputs.new_version }}\nç’°å¢ƒ: ${{ github.event.inputs.environment }}\n\nMLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶100%æº–æ‹ ãƒªãƒªãƒ¼ã‚¹\n- âœ… 29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ\n- âœ… 7ç¨®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ \n- âœ… å›ºå®šæ–™é‡‘è¨­å®šå®Œäº†\n- âœ… Univapayãƒ»GMOé€£æºæº–å‚™å®Œäº†",
              "fields": [
                {
                  "title": "æœ¬ç•ªç’°å¢ƒ",
                  "value": "${{ needs.production-release.result }}",
                  "short": true
                },
                {
                  "title": "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ",
                  "value": "${{ needs.staging-release.result }}",
                  "short": true
                },
                {
                  "title": "ãƒªãƒªãƒ¼ã‚¹å¾Œæ¤œè¨¼",
                  "value": "${{ needs.post-release-validation.result }}",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_RELEASES }