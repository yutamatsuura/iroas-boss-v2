# IROAS BOSS V2 - CI/CDè¨­å®šæ¤œè¨¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶æº–æ‹ ãƒ»CI/CDè¨­å®šå‹•ä½œç¢ºèª

name: ðŸ” CI/CD Configuration Validation

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/**'
      - 'deployment/**'

jobs:
  # ===================
  # YAMLæ–‡æ³•æ¤œè¨¼
  # ===================
  yaml-validation:
    name: ðŸ“„ YAMLæ–‡æ³•æ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ðŸ” YAML Lint
      uses: ibiqlik/action-yamllint@v3
      with:
        file_or_dir: .github/workflows/
        config_file: .github/yamllint-config.yml
        
    - name: ðŸ“„ GitHub Actions æ–‡æ³•ãƒã‚§ãƒƒã‚¯
      run: |
        echo "GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ–‡æ³•ãƒã‚§ãƒƒã‚¯"
        for file in .github/workflows/*.yml; do
          echo "æ¤œè¨¼ä¸­: $file"
          # åŸºæœ¬çš„ãªYAMLæ§‹é€ ç¢ºèª
          python -c "import yaml; yaml.safe_load(open('$file'))"
          echo "âœ… $file æ–‡æ³•OK"
        done

  # ===================
  # MLMãƒ“ã‚¸ãƒã‚¹è¨­å®šæ¤œè¨¼
  # ===================
  mlm-config-validation:
    name: ðŸ¢ MLMãƒ“ã‚¸ãƒã‚¹è¨­å®šæ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ðŸ¢ MLMè¨­å®šå€¤æ¤œè¨¼
      run: |
        echo "MLMãƒ“ã‚¸ãƒã‚¹è¨­å®šæ¤œè¨¼é–‹å§‹"
        
        # å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§MLMè¨­å®šç¢ºèª
        for file in .github/workflows/ci-cd-*.yml; do
          echo "æ¤œè¨¼ä¸­: $file"
          
          # å¿…é ˆç’°å¢ƒå¤‰æ•°ç¢ºèª
          if grep -q "HERO_PLAN_PRICE: 10670" "$file"; then
            echo "âœ… ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ—ãƒ©ãƒ³ä¾¡æ ¼è¨­å®šç¢ºèª"
          else
            echo "âŒ ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ—ãƒ©ãƒ³ä¾¡æ ¼è¨­å®šã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
          
          if grep -q "TEST_PLAN_PRICE: 9800" "$file"; then
            echo "âœ… ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ä¾¡æ ¼è¨­å®šç¢ºèª"
          else
            echo "âŒ ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ä¾¡æ ¼è¨­å®šã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
          
          if grep -q "MAX_MEMBERS: 50" "$file"; then
            echo "âœ… æœ€å¤§ä¼šå“¡æ•°è¨­å®šç¢ºèª"
          else
            echo "âŒ æœ€å¤§ä¼šå“¡æ•°è¨­å®šã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
          
          if grep -q "MINIMUM_PAYOUT_AMOUNT: 5000" "$file"; then
            echo "âœ… æœ€ä½ŽæŒ¯è¾¼é‡‘é¡è¨­å®šç¢ºèª"
          else
            echo "âŒ æœ€ä½ŽæŒ¯è¾¼é‡‘é¡è¨­å®šã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
          
          if grep -q "CSV_ENCODING.*Shift-JIS" "$file"; then
            echo "âœ… CSV ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šç¢ºèª"
          else
            echo "âŒ CSV ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
          
          echo "âœ… $file MLMè¨­å®šæ¤œè¨¼å®Œäº†"
        done

  # ===================
  # ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šæ¤œè¨¼
  # ===================
  deployment-config-validation:
    name: ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šæ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šæ¤œè¨¼
      run: |
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šæ¤œè¨¼é–‹å§‹"
        
        # Cloud Buildè¨­å®šç¢ºèª
        if [ -f "deployment/gcp/cloudbuild.yaml" ]; then
          echo "âœ… Cloud Buildè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨"
          
          # MLMç’°å¢ƒå¤‰æ•°ãŒCloud Buildã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if grep -q "_HERO_PLAN_PRICE" deployment/gcp/cloudbuild.yaml; then
            echo "âœ… Cloud Build MLMç’°å¢ƒå¤‰æ•°è¨­å®šç¢ºèª"
          else
            echo "âŒ Cloud Build MLMç’°å¢ƒå¤‰æ•°è¨­å®šã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
        else
          echo "âŒ Cloud Buildè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨"
          exit 1
        fi
        
        # Vercelè¨­å®šç¢ºèª
        if [ -f "deployment/vercel/vercel.json" ]; then
          echo "âœ… Vercelè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨"
        else
          echo "âŒ Vercelè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ç’°å¢ƒåˆ¥è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        for env in production staging development; do
          if [ -f "deployment/vercel/${env}.env" ]; then
            echo "âœ… $env ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨"
            
            # MLMè¨­å®šå€¤ç¢ºèª
            if grep -q "VITE_HERO_PLAN_PRICE=10670" "deployment/vercel/${env}.env"; then
              echo "âœ… $env ç’°å¢ƒMLMè¨­å®šç¢ºèª"
            else
              echo "âŒ $env ç’°å¢ƒMLMè¨­å®šã‚¨ãƒ©ãƒ¼"
              exit 1
            fi
          else
            echo "âŒ $env ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨"
            exit 1
          fi
        done

  # ===================
  # Secretè¨­å®šæ¤œè¨¼
  # ===================
  secrets-validation:
    name: ðŸ” Secretè¨­å®šæ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ðŸ” Secretè¨­å®šæ¤œè¨¼
      run: |
        echo "Secretè¨­å®šæ¤œè¨¼é–‹å§‹"
        
        # å¿…é ˆSecretä¸€è¦§
        required_secrets=(
          "GCP_SA_KEY"
          "GCP_SA_KEY_STAGING"
          "GCP_SA_KEY_DEV"
          "VERCEL_TOKEN"
          "VERCEL_ORG_ID"
          "VERCEL_PROJECT_ID"
          "VERCEL_PROJECT_ID_STAGING"
          "VERCEL_PROJECT_ID_DEV"
          "PRODUCTION_DATABASE_URL"
          "STAGING_DATABASE_URL"
          "DEVELOPMENT_DATABASE_URL"
          "SLACK_WEBHOOK_PRODUCTION"
          "SLACK_WEBHOOK_STAGING"
          "SLACK_WEBHOOK_DEVELOPMENT"
          "SLACK_WEBHOOK_TESTING"
          "SLACK_WEBHOOK_RELEASES"
        )
        
        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§Secretå‚ç…§ç¢ºèª
        for secret in "${required_secrets[@]}"; do
          if grep -r "\${{ secrets\.$secret }}" .github/workflows/; then
            echo "âœ… Secret $secret å‚ç…§ç¢ºèª"
          else
            echo "âš ï¸ Secret $secret å‚ç…§æœªç¢ºèªï¼ˆè¨­å®šãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰"
          fi
        done

  # ===================
  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚æ¤œè¨¼
  # ===================
  workflow-dependency-validation:
    name: ðŸ”— ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚æ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ðŸ”— ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚æ¤œè¨¼
      run: |
        echo "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚æ¤œè¨¼é–‹å§‹"
        
        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–“ã®å‘¼ã³å‡ºã—ç¢ºèª
        for file in .github/workflows/*.yml; do
          echo "æ¤œè¨¼ä¸­: $file"
          
          # workflow_dispatch è¨­å®šç¢ºèª
          if grep -q "workflow_dispatch:" "$file"; then
            echo "âœ… $file æ‰‹å‹•å®Ÿè¡Œå¯¾å¿œ"
          fi
          
          # ä»–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‘¼ã³å‡ºã—ç¢ºèª
          if grep -q "uses:.*workflow" "$file" || grep -q "workflow_id:" "$file"; then
            echo "âœ… $file ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–“é€£æºç¢ºèª"
          fi
          
          # å¿…è¦ãªjobså®šç¾©ç¢ºèª
          if grep -q "jobs:" "$file"; then
            echo "âœ… $file jobså®šç¾©ç¢ºèª"
          else
            echo "âŒ $file jobså®šç¾©ã‚¨ãƒ©ãƒ¼"
            exit 1
          fi
        done

  # ===================
  # æ¤œè¨¼çµæžœãƒ¬ãƒãƒ¼ãƒˆ
  # ===================
  validation-report:
    name: ðŸ“Š æ¤œè¨¼çµæžœãƒ¬ãƒãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    needs: [yaml-validation, mlm-config-validation, deployment-config-validation, secrets-validation, workflow-dependency-validation]
    if: always()
    
    steps:
    - name: ðŸ“Š æ¤œè¨¼çµæžœé›†ç´„
      run: |
        echo "## ðŸ” CI/CDè¨­å®šæ¤œè¨¼çµæžœãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ¤œè¨¼é …ç›®çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **YAMLæ–‡æ³•æ¤œè¨¼**: ${{ needs.yaml-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **MLMãƒ“ã‚¸ãƒã‚¹è¨­å®šæ¤œè¨¼**: ${{ needs.mlm-config-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šæ¤œè¨¼**: ${{ needs.deployment-config-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Secretè¨­å®šæ¤œè¨¼**: ${{ needs.secrets-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾å­˜é–¢ä¿‚æ¤œè¨¼**: ${{ needs.workflow-dependency-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### CI/CDæ§‹æˆç¢ºèª" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (ci-cd-production.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (ci-cd-staging.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (ci-cd-development.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (test-automation.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ãƒªãƒªãƒ¼ã‚¹ç®¡ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (release-management.yml)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶å¯¾å¿œç¢ºèª" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å›ºå®šæ–™é‡‘è¨­å®šï¼ˆHeroÂ¥10,670/TestÂ¥9,800ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ€å¤§ä¼šå“¡æ•°50ååˆ¶é™è¨­å®š" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ€ä½ŽæŒ¯è¾¼é‡‘é¡Â¥5,000è¨­å®š" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Shift-JIS CSVã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®š" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 7ç¨®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼è¨­å®š" >> $GITHUB_STEP_SUMMARY
        
        # å…¨æ¤œè¨¼æˆåŠŸç¢ºèª
        if [[ "${{ needs.yaml-validation.result }}" == "success" && \
              "${{ needs.mlm-config-validation.result }}" == "success" && \
              "${{ needs.deployment-config-validation.result }}" == "success" && \
              "${{ needs.secrets-validation.result }}" == "success" && \
              "${{ needs.workflow-dependency-validation.result }}" == "success" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **CI/CDè¨­å®šæ¤œè¨¼å®Œå…¨æˆåŠŸï¼**" >> $GITHUB_STEP_SUMMARY
          echo "Step 20 CI/CDæ§‹ç¯‰ã®æº–å‚™ãŒå®Œäº†ã—ã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **ä¸€éƒ¨æ¤œè¨¼ã§å•é¡ŒãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚**" >> $GITHUB_STEP_SUMMARY
        fi