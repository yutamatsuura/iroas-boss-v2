# IROAS BOSS V2 - é–‹ç™ºç’°å¢ƒ CI/CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶100%æº–æ‹ ãƒ»è¦ä»¶å®šç¾©æ›¸ç°¡ç•¥åŒ–å³ç¦

name: ğŸ› ï¸ Development Deployment

on:
  push:
    branches: [ feature/*, hotfix/*, bugfix/* ]
  workflow_dispatch:

env:
  # MLMãƒ“ã‚¸ãƒã‚¹å›ºæœ‰è¨­å®šï¼ˆè¦ä»¶å®šç¾©æ›¸æº–æ‹ ï¼‰
  HERO_PLAN_PRICE: 10670
  TEST_PLAN_PRICE: 9800
  MAX_MEMBERS: 50
  REWARD_CALCULATION_DAY: 25
  MINIMUM_PAYOUT_AMOUNT: 5000
  CSV_ENCODING: "Shift-JIS"
  
  # é–‹ç™ºç’°å¢ƒè¨­å®š
  ENVIRONMENT: development
  GCP_PROJECT_ID: iroas-boss-v2-dev
  GCP_SERVICE_NAME: iroas-boss-v2-backend-dev
  GCP_REGION: asia-northeast1
  VERCEL_PROJECT_NAME: iroas-boss-v2-dev

jobs:
  # ===================
  # é«˜é€Ÿå“è³ªæ¤œè¨¼
  # ===================
  quick-validation:
    name: âš¡ é«˜é€Ÿå“è³ªæ¤œè¨¼
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: iroas_boss_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ Pythonç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx
        
    - name: ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆMLMã‚¹ã‚­ãƒ¼ãƒï¼‰
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        alembic upgrade head
        
    - name: ğŸ§ª é‡è¦ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        # é‡è¦ãªMLMæ©Ÿèƒ½ã®ã¿ãƒ†ã‚¹ãƒˆ
        python -m pytest tests/unit/services/test_member_service.py -v
        python -m pytest tests/unit/services/test_reward_calculation_service.py -v
        python -m pytest tests/unit/services/test_payment_management_service.py -v
        
    - name: ğŸ” åŸºæœ¬MLMè¦ä»¶ãƒã‚§ãƒƒã‚¯
      run: |
        cd backend
        # åŸºæœ¬çš„ãªæ§‹é€ ãƒã‚§ãƒƒã‚¯ã®ã¿
        python -c "
        from app.models.member import Member
        fields = [f.name for f in Member.__table__.columns]
        assert len(fields) >= 29, f'ä¼šå“¡ãƒ‡ãƒ¼ã‚¿é …ç›®ä¸è¶³: {len(fields)}/29'
        print(f'âœ… ä¼šå“¡ãƒ‡ãƒ¼ã‚¿é …ç›®ç¢ºèª: {len(fields)}é …ç›®å¯¾å¿œ')
        "

  # ===================
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é«˜é€Ÿæ¤œè¨¼
  # ===================
  frontend-quick:
    name: ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é«˜é€Ÿæ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ” TypeScriptå‹ãƒã‚§ãƒƒã‚¯
      run: |
        cd frontend
        npm run type-check
        
    - name: ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼ˆé–‹ç™ºç’°å¢ƒè¨­å®šï¼‰
      env:
        VITE_API_BASE_URL: https://iroas-boss-v2-backend-dev.run.app
        VITE_HERO_PLAN_PRICE: 10670
        VITE_TEST_PLAN_PRICE: 9800
        VITE_MAX_MEMBERS: 50
        VITE_MINIMUM_PAYOUT_AMOUNT: 5000
        VITE_REWARD_CALCULATION_DAY: 25
      run: |
        cd frontend
        npm run build

  # ===================
  # é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
  # ===================
  deploy-development:
    name: ğŸ› ï¸ é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [quick-validation, frontend-quick]
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: ğŸ” Google Cloudèªè¨¼
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}
        
    - name: â˜ï¸ Google Cloud SDKè¨­å®š
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: ğŸ³ Dockerèªè¨¼è¨­å®š
      run: gcloud auth configure-docker asia-northeast1-docker.pkg.dev
      
    - name: ğŸ—ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
      run: |
        cd backend
        
        # Cloud Buildã§ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
        gcloud builds submit --config ../deployment/gcp/cloudbuild.yaml \
          --substitutions \
          BRANCH_NAME=${{ github.ref_name }},\
          _ENVIRONMENT=development,\
          _HERO_PLAN_PRICE=${{ env.HERO_PLAN_PRICE }},\
          _TEST_PLAN_PRICE=${{ env.TEST_PLAN_PRICE }},\
          _MAX_MEMBERS=${{ env.MAX_MEMBERS }},\
          _MINIMUM_PAYOUT_AMOUNT=${{ env.MINIMUM_PAYOUT_AMOUNT }},\
          _REWARD_CALCULATION_DAY=${{ env.REWARD_CALCULATION_DAY }},\
          _CSV_ENCODING=${{ env.CSV_ENCODING }}
          
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
    - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npm ci
        
    - name: ğŸš€ Vercelé–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        vercel-args: '--cwd frontend'
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_DEV }}
        working-directory: frontend
        
    - name: ğŸ©º é–‹ç™ºç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      run: |
        echo "é–‹ç™ºç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆè»½é‡ï¼‰
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if curl -f -s https://${{ env.GCP_SERVICE_NAME }}.run.app/health; then
            echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            break
          else
            echo "â³ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è©¦è¡Œ $attempt/$max_attempts"
            sleep 10
            attempt=$((attempt + 1))
          fi
        done

  # ===================
  # é–‹ç™ºç’°å¢ƒç°¡æ˜“æ¤œè¨¼
  # ===================
  development-validation:
    name: ğŸ” é–‹ç™ºç’°å¢ƒç°¡æ˜“æ¤œè¨¼
    runs-on: ubuntu-latest
    needs: [deploy-development]
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ§ª åŸºæœ¬æ©Ÿèƒ½æ¤œè¨¼
      run: |
        echo "é–‹ç™ºç’°å¢ƒåŸºæœ¬æ©Ÿèƒ½æ¤œè¨¼å®Ÿè¡Œä¸­..."
        
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIåŸºæœ¬ãƒã‚§ãƒƒã‚¯
        echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIåŸºæœ¬ãƒã‚§ãƒƒã‚¯"
        curl -f -s https://iroas-boss-v2-backend-dev.run.app/health || echo "âš ï¸ Backend health check failed"
        
        # ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå­˜åœ¨ç¢ºèª
        curl -s -o /dev/null -w "%{http_code}" https://iroas-boss-v2-backend-dev.run.app/api/v1/members | grep -E "^(200|401|403)$" && echo "âœ… Members APIç¢ºèª" || echo "âš ï¸ Members APIç•°å¸¸"
        curl -s -o /dev/null -w "%{http_code}" https://iroas-boss-v2-backend-dev.run.app/api/v1/rewards/history | grep -E "^(200|401|403)$" && echo "âœ… Rewards APIç¢ºèª" || echo "âš ï¸ Rewards APIç•°å¸¸"

  # ===================
  # é€šçŸ¥
  # ===================
  notify-development:
    name: ğŸ“¢ é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-development, development-validation]
    if: always()
    
    steps:
    - name: ğŸ“¢ Slacké€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#iroas-development'
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        custom_payload: |
          {
            "attachments": [{
              "color": "${{ job.status }}" === "success" ? "good" : "${{ job.status }}" === "failure" ? "danger" : "warning",
              "title": "ğŸ› ï¸ IROAS BOSS V2 é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤",
              "text": "${{ job.status }}" === "success" ? "âœ… é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ\n\næ©Ÿèƒ½é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†" : "âŒ é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—",
              "fields": [
                {
                  "title": "ãƒ–ãƒ©ãƒ³ãƒ",
                  "value": "${{ github.ref_name }}",
                  "short": true
                },
                {
                  "title": "ã‚³ãƒŸãƒƒãƒˆ",
                  "value": "${{ github.sha }}",
                  "short": true
                }
              ]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_DEVELOPMENT }}