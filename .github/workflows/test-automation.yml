# IROAS BOSS V2 - ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶100%æº–æ‹ ãƒ»ç¶™ç¶šå“è³ªä¿è¨¼

name: ğŸ§ª Automated Testing

on:
  schedule:
    # æ¯æ—¥ AM 2:00 (JST) ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆé¸æŠ'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - unit_only
        - integration_only
        - e2e_only
        - mlm_business_only

env:
  # MLMãƒ“ã‚¸ãƒã‚¹å›ºæœ‰è¨­å®šï¼ˆè¦ä»¶å®šç¾©æ›¸æº–æ‹ ï¼‰
  HERO_PLAN_PRICE: 10670
  TEST_PLAN_PRICE: 9800
  MAX_MEMBERS: 50
  REWARD_CALCULATION_DAY: 25
  MINIMUM_PAYOUT_AMOUNT: 5000
  CSV_ENCODING: "Shift-JIS"

jobs:
  # ===================
  # MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶é©åˆæ€§ãƒ†ã‚¹ãƒˆ
  # ===================
  mlm-business-compliance:
    name: ğŸ¢ MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶é©åˆæ€§ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'full' || github.event.inputs.test_suite == 'mlm_business_only' || github.event_name == 'schedule'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: iroas_boss_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ Pythonç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio httpx
        
    - name: ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆMLMã‚¹ã‚­ãƒ¼ãƒï¼‰
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        alembic upgrade head
        
    - name: ğŸ¢ 29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œæ¤œè¨¼
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        python -c "
        from app.models.member import Member
        from app.database import get_db_session
        import asyncio
        
        async def verify_member_fields():
            fields = [f.name for f in Member.__table__.columns]
            required_fields = [
                'id', 'member_number', 'status', 'name', 'name_kana', 'email',
                'phone', 'postal_code', 'address', 'birth_date', 'gender',
                'plan', 'registration_date', 'payment_method', 'card_last4',
                'bank_name', 'branch_name', 'account_type', 'account_number',
                'account_name', 'upline_id', 'sponsor_id', 'referrer_id',
                'left_child_id', 'right_child_id', 'depth', 'left_count',
                'right_count', 'total_sales', 'created_at', 'updated_at'
            ]
            
            missing_fields = [field for field in required_fields if field not in fields]
            if missing_fields:
                raise AssertionError(f'å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸è¶³: {missing_fields}')
            
            print(f'âœ… ä¼šå“¡ãƒ‡ãƒ¼ã‚¿é …ç›®ç¢ºèª: {len(fields)}é …ç›®å¯¾å¿œ (æœ€ä½29é …ç›®ã‚¯ãƒªã‚¢)')
            return True
        
        asyncio.run(verify_member_fields())
        "
        
    - name: ğŸ¢ 7ç¨®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        python -c "
        from app.services.reward_calculation_service import RewardCalculationService
        from app.models.reward import RewardType
        import asyncio
        
        async def verify_bonus_types():
            required_bonus_types = [
                'daily', 'title', 'referral', 'power', 
                'maintenance', 'sales_activity', 'royal_family'
            ]
            
            # RewardTypeãŒ7ç¨®é¡å¯¾å¿œã—ã¦ã„ã‚‹ã‹ç¢ºèª
            for bonus_type in required_bonus_types:
                try:
                    reward_type = RewardType(bonus_type)
                    print(f'âœ… {bonus_type} ãƒœãƒ¼ãƒŠã‚¹å¯¾å¿œç¢ºèª')
                except ValueError:
                    raise AssertionError(f'{bonus_type} ãƒœãƒ¼ãƒŠã‚¹æœªå¯¾å¿œ')
            
            print('âœ… 7ç¨®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œç¢ºèªå®Œäº†')
            return True
        
        asyncio.run(verify_bonus_types())
        "
        
    - name: ğŸ¢ å›ºå®šæ–™é‡‘è¨­å®šæ¤œè¨¼
      run: |
        cd backend
        python -c "
        import os
        
        # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ–™é‡‘è¨­å®šç¢ºèª
        hero_price = int(os.environ.get('HERO_PLAN_PRICE', 0))
        test_price = int(os.environ.get('TEST_PLAN_PRICE', 0))
        max_members = int(os.environ.get('MAX_MEMBERS', 0))
        min_payout = int(os.environ.get('MINIMUM_PAYOUT_AMOUNT', 0))
        
        assert hero_price == 10670, f'ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ—ãƒ©ãƒ³ä¾¡æ ¼ç•°å¸¸: {hero_price} != 10670'
        assert test_price == 9800, f'ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ä¾¡æ ¼ç•°å¸¸: {test_price} != 9800'
        assert max_members == 50, f'æœ€å¤§ä¼šå“¡æ•°ç•°å¸¸: {max_members} != 50'
        assert min_payout == 5000, f'æœ€ä½æŒ¯è¾¼é‡‘é¡ç•°å¸¸: {min_payout} != 5000'
        
        print('âœ… å›ºå®šæ–™é‡‘è¨­å®šç¢ºèªå®Œäº†')
        print(f'  - ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ—ãƒ©ãƒ³: Â¥{hero_price:,}')
        print(f'  - ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³: Â¥{test_price:,}')
        print(f'  - æœ€å¤§ä¼šå“¡æ•°: {max_members}å')
        print(f'  - æœ€ä½æŒ¯è¾¼é‡‘é¡: Â¥{min_payout:,}')
        "

  # ===================
  # å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # ===================
  unit-tests:
    name: ğŸ”¬ å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'full' || github.event.inputs.test_suite == 'unit_only' || github.event_name == 'schedule'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: iroas_boss_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ Pythonç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio httpx pytest-xdist
        
    - name: ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        alembic upgrade head
        
    - name: ğŸ”¬ å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        python -m pytest tests/unit/ -v --cov=app --cov-report=term-missing --cov-report=xml --cov-report=html -n auto
        
    - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: unit-tests
        name: unit-test-coverage

  # ===================
  # çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # ===================
  integration-tests:
    name: ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'full' || github.event.inputs.test_suite == 'integration_only' || github.event_name == 'schedule'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: iroas_boss_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ Pythonç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx
        
    - name: ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        alembic upgrade head
        
    - name: ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/iroas_boss_test
      run: |
        cd backend
        python -m pytest tests/integration/ -v --tb=short

  # ===================
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰E2Eãƒ†ã‚¹ãƒˆ
  # ===================
  e2e-tests:
    name: ğŸ­ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰E2Eãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'full' || github.event.inputs.test_suite == 'e2e_only' || github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ­ Playwrightã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        cd frontend
        npx playwright install --with-deps
        
    - name: ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      run: |
        cd frontend
        npm run dev &
        sleep 30
        
    - name: ğŸ­ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        cd frontend
        npx playwright test --reporter=html
        
    - name: ğŸ“Š E2Eãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-automated
        path: frontend/playwright-report/
        retention-days: 7

  # ===================
  # ãƒ†ã‚¹ãƒˆçµæœé›†ç´„ãƒ»é€šçŸ¥
  # ===================
  test-summary:
    name: ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœé›†ç´„
    runs-on: ubuntu-latest
    needs: [mlm-business-compliance, unit-tests, integration-tests, e2e-tests]
    if: always()
    
    steps:
    - name: ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœé›†ç´„
      run: |
        echo "## ğŸ§ª IROAS BOSS V2 è‡ªå‹•ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "- **MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶é©åˆæ€§**: ${{ needs.mlm-business-compliance.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å˜ä½“ãƒ†ã‚¹ãƒˆ**: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **çµ±åˆãƒ†ã‚¹ãƒˆ**: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **E2Eãƒ†ã‚¹ãƒˆ**: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶ç¢ºèªé …ç›®" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 29é …ç›®ä¼šå“¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 7ç¨®ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ " >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å›ºå®šæ–™é‡‘è¨­å®šï¼ˆHeroÂ¥10,670/TestÂ¥9,800ï¼‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ€å¤§ä¼šå“¡æ•°50ååˆ¶é™" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ€ä½æŒ¯è¾¼é‡‘é¡Â¥5,000è¨­å®š" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ“¢ Slacké€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: custom
        channel: '#iroas-testing'
        custom_payload: |
          {
            "attachments": [{
              "color": "${{ needs.mlm-business-compliance.result == 'success' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.e2e-tests.result == 'success' }}" === "true" ? "good" : "danger",
              "title": "ğŸ§ª IROAS BOSS V2 è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†",
              "fields": [
                {
                  "title": "MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶é©åˆæ€§",
                  "value": "${{ needs.mlm-business-compliance.result }}",
                  "short": true
                },
                {
                  "title": "å˜ä½“ãƒ†ã‚¹ãƒˆ",
                  "value": "${{ needs.unit-tests.result }}",
                  "short": true
                },
                {
                  "title": "çµ±åˆãƒ†ã‚¹ãƒˆ",
                  "value": "${{ needs.integration-tests.result }}",
                  "short": true
                },
                {
                  "title": "E2Eãƒ†ã‚¹ãƒˆ",
                  "value": "${{ needs.e2e-tests.result }}",
                  "short": true
                }
              ],
              "footer": "IROAS BOSS V2 è‡ªå‹•å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ "
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_TESTING }}