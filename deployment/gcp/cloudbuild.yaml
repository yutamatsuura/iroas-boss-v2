# IROAS BOSS V2 - Cloud BuildË®≠ÂÆö
# MLM„Éì„Ç∏„Éç„ÇπË¶Å‰ª∂100%Ê∫ñÊã†„ÉªCI/CDËá™Âãï„Éá„Éó„É≠„Ç§Ë®≠ÂÆö

steps:
  # 1. MLM„Éì„Ç∏„Éç„ÇπË®≠ÂÆöÊ§úË®º
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîç MLM„Éì„Ç∏„Éç„ÇπË®≠ÂÆöÊ§úË®ºÈñãÂßã"
        echo "Áí∞Â¢É: $_ENVIRONMENT"
        echo "„Éí„Éº„É≠„Éº„Éó„É©„É≥‰æ°Ê†º: $_HERO_PLAN_PRICE"
        echo "„ÉÜ„Çπ„Éà„Éó„É©„É≥‰æ°Ê†º: $_TEST_PLAN_PRICE"
        echo "ÊúÄÂ§ß‰ºöÂì°Êï∞: $_MAX_MEMBERS"
        echo "ÊúÄ‰ΩéÊåØËæºÈáëÈ°ç: $_MINIMUM_PAYOUT_AMOUNT"
        echo "Â†±ÈÖ¨Ë®àÁÆóÊó•: $_REWARD_CALCULATION_DAY"
        echo "CSV „Ç®„É≥„Ç≥„Éº„Éá„Ç£„É≥„Ç∞: $_CSV_ENCODING"

  # 2. Docker „Ç§„É°„Éº„Ç∏„Éì„É´„ÉâÔºàMLMÁí∞Â¢ÉÂ§âÊï∞‰ªò„ÅçÔºâ
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build' 
      - '-f'
      - 'deployment/gcp/Dockerfile'
      - '--build-arg'
      - 'ENVIRONMENT=$_ENVIRONMENT'
      - '--build-arg'
      - 'HERO_PLAN_PRICE=$_HERO_PLAN_PRICE'
      - '--build-arg'
      - 'TEST_PLAN_PRICE=$_TEST_PLAN_PRICE'
      - '--build-arg'
      - 'MAX_MEMBERS=$_MAX_MEMBERS'
      - '--build-arg'
      - 'MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT'
      - '--build-arg'
      - 'REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY'
      - '--build-arg'
      - 'CSV_ENCODING=$_CSV_ENCODING'
      - '-t' 
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-$_ENVIRONMENT:$SHORT_SHA'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-$_ENVIRONMENT:latest'
      - '.'
    
  # 3. Docker „Ç§„É°„Éº„Ç∏„ÇíArtifact Registry„Å´„Éó„ÉÉ„Ç∑„É•
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'push' 
      - '--all-tags'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-$_ENVIRONMENT'
  
  # 4. Êú¨Áï™Áí∞Â¢É„Éá„Éó„É≠„Ç§ (main„Éñ„É©„É≥„ÉÅ„ÅÆ„Åø)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "main" && "$_ENVIRONMENT" == "production" ]]; then
          echo "üöÄ Êú¨Áï™Áí∞Â¢É„Éá„Éó„É≠„Ç§ÈñãÂßã"
          gcloud run deploy iroas-boss-v2-backend \
            --image asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-production:$SHORT_SHA \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --service-account=iroas-boss-v2-backend@$PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars="ENVIRONMENT=production,HERO_PLAN_PRICE=$_HERO_PLAN_PRICE,TEST_PLAN_PRICE=$_TEST_PLAN_PRICE,MAX_MEMBERS=$_MAX_MEMBERS,MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT,REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY,CSV_ENCODING=$_CSV_ENCODING" \
            --set-env-vars="DATABASE_URL=$$DATABASE_URL_PRODUCTION,REDIS_URL=$$REDIS_URL_PRODUCTION,SECRET_KEY=$$SECRET_KEY_PRODUCTION,UNIVAPAY_API_KEY=$$UNIVAPAY_API_KEY_PRODUCTION,GMO_BANK_API_KEY=$$GMO_BANK_API_KEY_PRODUCTION,CSV_ENCRYPTION_KEY=$$CSV_ENCRYPTION_KEY_PRODUCTION" \
            --memory 2Gi \
            --cpu 2 \
            --max-instances 10 \
            --min-instances 1 \
            --concurrency 80 \
            --timeout 900 \
            --port 8000
          echo "‚úÖ Êú¨Áï™Áí∞Â¢É„Éá„Éó„É≠„Ç§ÂÆå‰∫Ü"
        fi
    secretEnv: ['DATABASE_URL_PRODUCTION', 'REDIS_URL_PRODUCTION', 'SECRET_KEY_PRODUCTION', 'UNIVAPAY_API_KEY_PRODUCTION', 'GMO_BANK_API_KEY_PRODUCTION', 'CSV_ENCRYPTION_KEY_PRODUCTION']
  
  # 5. „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Éá„Éó„É≠„Ç§ (develop„Éñ„É©„É≥„ÉÅ)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "develop" && "$_ENVIRONMENT" == "staging" ]]; then
          echo "üöß „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Éá„Éó„É≠„Ç§ÈñãÂßã"
          gcloud run deploy iroas-boss-v2-backend-staging \
            --image asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-staging:$SHORT_SHA \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --service-account=iroas-boss-v2-backend-staging@$PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars="ENVIRONMENT=staging,HERO_PLAN_PRICE=$_HERO_PLAN_PRICE,TEST_PLAN_PRICE=$_TEST_PLAN_PRICE,MAX_MEMBERS=$_MAX_MEMBERS,MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT,REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY,CSV_ENCODING=$_CSV_ENCODING" \
            --set-env-vars="DATABASE_URL=$$DATABASE_URL_STAGING,REDIS_URL=$$REDIS_URL_STAGING,SECRET_KEY=$$SECRET_KEY_STAGING,UNIVAPAY_API_KEY=$$UNIVAPAY_API_KEY_STAGING,GMO_BANK_API_KEY=$$GMO_BANK_API_KEY_STAGING,CSV_ENCRYPTION_KEY=$$CSV_ENCRYPTION_KEY_STAGING" \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 5 \
            --min-instances 0 \
            --concurrency 50 \
            --timeout 600 \
            --port 8000
          echo "‚úÖ „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Éá„Éó„É≠„Ç§ÂÆå‰∫Ü"
        fi
    secretEnv: ['DATABASE_URL_STAGING', 'REDIS_URL_STAGING', 'SECRET_KEY_STAGING', 'UNIVAPAY_API_KEY_STAGING', 'GMO_BANK_API_KEY_STAGING', 'CSV_ENCRYPTION_KEY_STAGING']

  # 6. ÈñãÁô∫Áí∞Â¢É„Éá„Éó„É≠„Ç§ (feature/hotfix/bugfix„Éñ„É©„É≥„ÉÅ)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$_ENVIRONMENT" == "development" ]]; then
          echo "üõ†Ô∏è ÈñãÁô∫Áí∞Â¢É„Éá„Éó„É≠„Ç§ÈñãÂßã"
          gcloud run deploy iroas-boss-v2-backend-dev \
            --image asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-development:$SHORT_SHA \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --service-account=iroas-boss-v2-backend-dev@$PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars="ENVIRONMENT=development,HERO_PLAN_PRICE=$_HERO_PLAN_PRICE,TEST_PLAN_PRICE=$_TEST_PLAN_PRICE,MAX_MEMBERS=$_MAX_MEMBERS,MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT,REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY,CSV_ENCODING=$_CSV_ENCODING" \
            --set-env-vars="DATABASE_URL=$$DATABASE_URL_DEVELOPMENT,SECRET_KEY=$$SECRET_KEY_DEVELOPMENT" \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 2 \
            --min-instances 0 \
            --concurrency 20 \
            --timeout 300 \
            --port 8000
          echo "‚úÖ ÈñãÁô∫Áí∞Â¢É„Éá„Éó„É≠„Ç§ÂÆå‰∫Ü"
        fi
    secretEnv: ['DATABASE_URL_DEVELOPMENT', 'SECRET_KEY_DEVELOPMENT']

  # 7. „Éá„Éó„É≠„Ç§Âæå„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
  - name: 'gcr.io/cloud-builders/curl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ü©∫ „Éá„Éó„É≠„Ç§Âæå„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÂÆüË°å"
        
        if [[ "$_ENVIRONMENT" == "production" ]]; then
          SERVICE_URL="https://iroas-boss-v2-backend.run.app"
        elif [[ "$_ENVIRONMENT" == "staging" ]]; then
          SERVICE_URL="https://iroas-boss-v2-backend-staging.run.app"
        elif [[ "$_ENVIRONMENT" == "development" ]]; then
          SERVICE_URL="https://iroas-boss-v2-backend-dev.run.app"
        fi
        
        echo "„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÂØæË±°: $SERVICE_URL"
        
        max_attempts=30
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if curl -f -s "$SERVICE_URL/health"; then
            echo "‚úÖ $_ENVIRONMENT Áí∞Â¢É„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÊàêÂäü"
            break
          else
            echo "‚è≥ „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØË©¶Ë°å $attempt/$max_attempts"
            sleep 10
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "‚ùå $_ENVIRONMENT Áí∞Â¢É„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó"
          exit 1
        fi

# Áí∞Â¢ÉÂ§âÊï∞„ÅÆÊöóÂè∑Âåñ„Åï„Çå„ÅüÂÄ§„Çí‰ΩøÁî®
availableSecrets:
  secretManager:
    # Êú¨Áï™Áí∞Â¢É„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà
    - versionName: projects/$PROJECT_ID/secrets/database-url-production/versions/latest
      env: 'DATABASE_URL_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/redis-url-production/versions/latest
      env: 'REDIS_URL_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/secret-key-production/versions/latest
      env: 'SECRET_KEY_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/univapay-api-key-production/versions/latest
      env: 'UNIVAPAY_API_KEY_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/gmo-bank-api-key-production/versions/latest
      env: 'GMO_BANK_API_KEY_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/csv-encryption-key-production/versions/latest
      env: 'CSV_ENCRYPTION_KEY_PRODUCTION'
    
    # „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà
    - versionName: projects/$PROJECT_ID/secrets/database-url-staging/versions/latest  
      env: 'DATABASE_URL_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/redis-url-staging/versions/latest
      env: 'REDIS_URL_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/secret-key-staging/versions/latest
      env: 'SECRET_KEY_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/univapay-api-key-staging/versions/latest
      env: 'UNIVAPAY_API_KEY_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/gmo-bank-api-key-staging/versions/latest
      env: 'GMO_BANK_API_KEY_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/csv-encryption-key-staging/versions/latest
      env: 'CSV_ENCRYPTION_KEY_STAGING'
    
    # ÈñãÁô∫Áí∞Â¢É„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà
    - versionName: projects/$PROJECT_ID/secrets/database-url-development/versions/latest
      env: 'DATABASE_URL_DEVELOPMENT'
    - versionName: projects/$PROJECT_ID/secrets/secret-key-development/versions/latest
      env: 'SECRET_KEY_DEVELOPMENT'

# „Éì„É´„Éâ„Ç™„Éó„Ç∑„Éß„É≥
options:
  machineType: 'E2_HIGHCPU_8'
  substitution_option: 'ALLOW_LOOSE'
  logging: CLOUD_LOGGING_ONLY

# „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆö
timeout: 1800s

# ÁΩÆÊèõÂ§âÊï∞ÔºàMLM„Éì„Ç∏„Éç„ÇπË¶Å‰ª∂Ê∫ñÊã†Ôºâ
substitutions:
  # „Éá„Éï„Ç©„É´„ÉàÂÄ§Ë®≠ÂÆö
  _REGION: 'asia-northeast1'
  _SERVICE_NAME: 'iroas-boss-v2-backend'
  _ENVIRONMENT: 'production'
  
  # MLM„Éì„Ç∏„Éç„ÇπÂõ∫ÊúâË®≠ÂÆöÔºàË¶Å‰ª∂ÂÆöÁæ©Êõ∏Ê∫ñÊã†Ôºâ
  _HERO_PLAN_PRICE: '10670'
  _TEST_PLAN_PRICE: '9800'
  _MAX_MEMBERS: '50'
  _REWARD_CALCULATION_DAY: '25'
  _MINIMUM_PAYOUT_AMOUNT: '5000'
  _CSV_ENCODING: 'Shift-JIS'

# „Éì„É´„Éâ„É≠„Ç∞Ë®≠ÂÆö
logsBucket: 'gs://iroas-boss-v2-build-logs'