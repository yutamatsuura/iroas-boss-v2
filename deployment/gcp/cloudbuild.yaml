# IROAS BOSS V2 - Cloud Buildè¨­å®š
# MLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶100%æº–æ‹ ãƒ»CI/CDè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

steps:
  # 1. MLMãƒ“ã‚¸ãƒã‚¹è¨­å®šæ¤œè¨¼
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” MLMãƒ“ã‚¸ãƒã‚¹è¨­å®šæ¤œè¨¼é–‹å§‹"
        echo "ç’°å¢ƒ: $_ENVIRONMENT"
        echo "ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ—ãƒ©ãƒ³ä¾¡æ ¼: $_HERO_PLAN_PRICE"
        echo "ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ä¾¡æ ¼: $_TEST_PLAN_PRICE"
        echo "æœ€å¤§ä¼šå“¡æ•°: $_MAX_MEMBERS"
        echo "æœ€ä½æŒ¯è¾¼é‡‘é¡: $_MINIMUM_PAYOUT_AMOUNT"
        echo "å ±é…¬è¨ˆç®—æ—¥: $_REWARD_CALCULATION_DAY"
        echo "CSV ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: $_CSV_ENCODING"

  # 2. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆMLMç’°å¢ƒå¤‰æ•°ä»˜ãï¼‰
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'build' 
      - '-f'
      - 'deployment/gcp/Dockerfile'
      - '--build-arg'
      - 'ENVIRONMENT=$_ENVIRONMENT'
      - '--build-arg'
      - 'HERO_PLAN_PRICE=$_HERO_PLAN_PRICE'
      - '--build-arg'
      - 'TEST_PLAN_PRICE=$_TEST_PLAN_PRICE'
      - '--build-arg'
      - 'MAX_MEMBERS=$_MAX_MEMBERS'
      - '--build-arg'
      - 'MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT'
      - '--build-arg'
      - 'REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY'
      - '--build-arg'
      - 'CSV_ENCODING=$_CSV_ENCODING'
      - '-t' 
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-$_ENVIRONMENT:$SHORT_SHA'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-$_ENVIRONMENT:latest'
      - '.'
    
  # 3. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Artifact Registryã«ãƒ—ãƒƒã‚·ãƒ¥
  - name: 'gcr.io/cloud-builders/docker'
    args: 
      - 'push' 
      - '--all-tags'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-$_ENVIRONMENT'
  
  # 4. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (mainãƒ–ãƒ©ãƒ³ãƒã®ã¿)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "main" && "$_ENVIRONMENT" == "production" ]]; then
          echo "ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
          gcloud run deploy iroas-boss-v2-backend \
            --image asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-production:$SHORT_SHA \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --service-account=iroas-boss-v2-backend@$PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars="ENVIRONMENT=production,HERO_PLAN_PRICE=$_HERO_PLAN_PRICE,TEST_PLAN_PRICE=$_TEST_PLAN_PRICE,MAX_MEMBERS=$_MAX_MEMBERS,MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT,REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY,CSV_ENCODING=$_CSV_ENCODING" \
            --set-env-vars="DATABASE_URL=$$DATABASE_URL_PRODUCTION,REDIS_URL=$$REDIS_URL_PRODUCTION,SECRET_KEY=$$SECRET_KEY_PRODUCTION,UNIVAPAY_API_KEY=$$UNIVAPAY_API_KEY_PRODUCTION,GMO_BANK_API_KEY=$$GMO_BANK_API_KEY_PRODUCTION,CSV_ENCRYPTION_KEY=$$CSV_ENCRYPTION_KEY_PRODUCTION" \
            --memory 2Gi \
            --cpu 2 \
            --max-instances 10 \
            --min-instances 1 \
            --concurrency 80 \
            --timeout 900 \
            --port 8000
          echo "âœ… æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        fi
    secretEnv: ['DATABASE_URL_PRODUCTION', 'REDIS_URL_PRODUCTION', 'SECRET_KEY_PRODUCTION', 'UNIVAPAY_API_KEY_PRODUCTION', 'GMO_BANK_API_KEY_PRODUCTION', 'CSV_ENCRYPTION_KEY_PRODUCTION']
  
  # 5. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (developãƒ–ãƒ©ãƒ³ãƒ)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "develop" && "$_ENVIRONMENT" == "staging" ]]; then
          echo "ğŸš§ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
          gcloud run deploy iroas-boss-v2-backend-staging \
            --image asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-staging:$SHORT_SHA \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --service-account=iroas-boss-v2-backend-staging@$PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars="ENVIRONMENT=staging,HERO_PLAN_PRICE=$_HERO_PLAN_PRICE,TEST_PLAN_PRICE=$_TEST_PLAN_PRICE,MAX_MEMBERS=$_MAX_MEMBERS,MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT,REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY,CSV_ENCODING=$_CSV_ENCODING" \
            --set-env-vars="DATABASE_URL=$$DATABASE_URL_STAGING,REDIS_URL=$$REDIS_URL_STAGING,SECRET_KEY=$$SECRET_KEY_STAGING,UNIVAPAY_API_KEY=$$UNIVAPAY_API_KEY_STAGING,GMO_BANK_API_KEY=$$GMO_BANK_API_KEY_STAGING,CSV_ENCRYPTION_KEY=$$CSV_ENCRYPTION_KEY_STAGING" \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 5 \
            --min-instances 0 \
            --concurrency 50 \
            --timeout 600 \
            --port 8000
          echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        fi
    secretEnv: ['DATABASE_URL_STAGING', 'REDIS_URL_STAGING', 'SECRET_KEY_STAGING', 'UNIVAPAY_API_KEY_STAGING', 'GMO_BANK_API_KEY_STAGING', 'CSV_ENCRYPTION_KEY_STAGING']

  # 6. é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (feature/hotfix/bugfixãƒ–ãƒ©ãƒ³ãƒ)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$_ENVIRONMENT" == "development" ]]; then
          echo "ğŸ› ï¸ é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
          gcloud run deploy iroas-boss-v2-backend-dev \
            --image asia-northeast1-docker.pkg.dev/$PROJECT_ID/iroas-boss-v2/backend-development:$SHORT_SHA \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --service-account=iroas-boss-v2-backend-dev@$PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars="ENVIRONMENT=development,HERO_PLAN_PRICE=$_HERO_PLAN_PRICE,TEST_PLAN_PRICE=$_TEST_PLAN_PRICE,MAX_MEMBERS=$_MAX_MEMBERS,MINIMUM_PAYOUT_AMOUNT=$_MINIMUM_PAYOUT_AMOUNT,REWARD_CALCULATION_DAY=$_REWARD_CALCULATION_DAY,CSV_ENCODING=$_CSV_ENCODING" \
            --set-env-vars="DATABASE_URL=$$DATABASE_URL_DEVELOPMENT,SECRET_KEY=$$SECRET_KEY_DEVELOPMENT" \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 2 \
            --min-instances 0 \
            --concurrency 20 \
            --timeout 300 \
            --port 8000
          echo "âœ… é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        fi
    secretEnv: ['DATABASE_URL_DEVELOPMENT', 'SECRET_KEY_DEVELOPMENT']

  # 7. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  - name: 'gcr.io/cloud-builders/curl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ©º ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
        
        if [[ "$_ENVIRONMENT" == "production" ]]; then
          SERVICE_URL="https://iroas-boss-v2-backend.run.app"
        elif [[ "$_ENVIRONMENT" == "staging" ]]; then
          SERVICE_URL="https://iroas-boss-v2-backend-staging.run.app"
        elif [[ "$_ENVIRONMENT" == "development" ]]; then
          SERVICE_URL="https://iroas-boss-v2-backend-dev.run.app"
        fi
        
        echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¯¾è±¡: $SERVICE_URL"
        
        max_attempts=30
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          if curl -f -s "$SERVICE_URL/health"; then
            echo "âœ… $_ENVIRONMENT ç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            break
          else
            echo "â³ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è©¦è¡Œ $attempt/$max_attempts"
            sleep 10
            attempt=$((attempt + 1))
          fi
        done
        
        if [ $attempt -gt $max_attempts ]; then
          echo "âŒ $_ENVIRONMENT ç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
          exit 1
        fi

# ç’°å¢ƒå¤‰æ•°ã®æš—å·åŒ–ã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨
availableSecrets:
  secretManager:
    # æœ¬ç•ªç’°å¢ƒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
    - versionName: projects/$PROJECT_ID/secrets/database-url-production/versions/latest
      env: 'DATABASE_URL_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/redis-url-production/versions/latest
      env: 'REDIS_URL_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/secret-key-production/versions/latest
      env: 'SECRET_KEY_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/univapay-api-key-production/versions/latest
      env: 'UNIVAPAY_API_KEY_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/gmo-bank-api-key-production/versions/latest
      env: 'GMO_BANK_API_KEY_PRODUCTION'
    - versionName: projects/$PROJECT_ID/secrets/csv-encryption-key-production/versions/latest
      env: 'CSV_ENCRYPTION_KEY_PRODUCTION'
    
    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
    - versionName: projects/$PROJECT_ID/secrets/database-url-staging/versions/latest  
      env: 'DATABASE_URL_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/redis-url-staging/versions/latest
      env: 'REDIS_URL_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/secret-key-staging/versions/latest
      env: 'SECRET_KEY_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/univapay-api-key-staging/versions/latest
      env: 'UNIVAPAY_API_KEY_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/gmo-bank-api-key-staging/versions/latest
      env: 'GMO_BANK_API_KEY_STAGING'
    - versionName: projects/$PROJECT_ID/secrets/csv-encryption-key-staging/versions/latest
      env: 'CSV_ENCRYPTION_KEY_STAGING'
    
    # é–‹ç™ºç’°å¢ƒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
    - versionName: projects/$PROJECT_ID/secrets/database-url-development/versions/latest
      env: 'DATABASE_URL_DEVELOPMENT'
    - versionName: projects/$PROJECT_ID/secrets/secret-key-development/versions/latest
      env: 'SECRET_KEY_DEVELOPMENT'

# ãƒ“ãƒ«ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³
options:
  machineType: 'E2_HIGHCPU_8'
  substitution_option: 'ALLOW_LOOSE'
  logging: CLOUD_LOGGING_ONLY

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
timeout: 1800s

# ç½®æ›å¤‰æ•°ï¼ˆMLMãƒ“ã‚¸ãƒã‚¹è¦ä»¶æº–æ‹ ï¼‰
substitutions:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
  _REGION: 'asia-northeast1'
  _SERVICE_NAME: 'iroas-boss-v2-backend'
  _ENVIRONMENT: 'production'
  
  # MLMãƒ“ã‚¸ãƒã‚¹å›ºæœ‰è¨­å®šï¼ˆè¦ä»¶å®šç¾©æ›¸æº–æ‹ ï¼‰
  _HERO_PLAN_PRICE: '10670'
  _TEST_PLAN_PRICE: '9800'
  _MAX_MEMBERS: '50'
  _REWARD_CALCULATION_DAY: '25'
  _MINIMUM_PAYOUT_AMOUNT: '5000'
  _CSV_ENCODING: 'Shift-JIS'

# ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°è¨­å®š
logsBucket: 'gs://iroas-boss-v2-build-logs'